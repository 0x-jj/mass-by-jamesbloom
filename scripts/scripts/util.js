function hashString(e){let t=5381;for(let r=0;r<e.length;r++)t=33*t^e.charCodeAt(r);return t>>>0}function rand(e,t,r=.001){if(e==t)return e;if(e>t){let a=e;e=t,t=a}let n=randomNumberGenerator.random(),o=(t-e)/r+r;return e+Math.floor(n*o)*r}function randS(e,t,r=.001){if(e==t)return e;if(e>t){let a=e;e=t,t=a}let n=randomNumberGeneratorSeeded.random(),o=(t-e)/r+r;return e+Math.floor(n*o)*r}function randFromRange(e){return rand(e[0],e[1],e[2])}function randFromRangeS(e){let t=randS(e[0],e[1],e[2]);return[t,t,1]}function randFromRangeS2(e){return randS(e[0],e[1],e[2])}function shuffle(e){for(let t=e.length-1;t>0;t--){let r=Math.floor(randomNumberGenerator.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}function shuffleS(e){for(let t=e.length-1;t>0;t--){let r=Math.floor(randS(0,1,.01)*t);[e[t],e[r]]=[e[r],e[t]]}return e}function pick(e){return e[rand(0,e.length-1,1)]}function pickS(e){return e[randS(0,e.length-1,1)]}function pickS2(e){let t=JSON.parse(JSON.stringify(e));if(shuffleS(t),1==t.length){let r=t.pop();return[r,r]}for(v1=t.pop(),v3=v2=t.pop();v1==v2;){if(0==t.length){v2=v3;break}v2=t.pop()}return[v1,v2]}function numberOfShapesMinMax(e){return Array.isArray(e)?randFromRangeS(e)[0]:e}function pickFromProbabilityArrayS(e){let t=JSON.parse(JSON.stringify(e));shuffleS(t);let r=0,a=-1,n=null,o=randS(0,1,.01);for(let i=0;i<t.length;i++){if(o<(r+=t[i][0]))return t[i][1];t[i][0]>a&&(a=t[i][0],n=t[i])}return n[1]}function pickFromProbabilityMapS(e){let t=JSON.parse(JSON.stringify(e));shuffleS(t);let r=0,a=-1,n=null,o=randS(0,1,.01);for(let i=0;i<t.length;i++){if(o<(r+=t[i].probability))return t[i];t[i].probability>a&&(a=t[i].probability,n=t[i])}return n}function smallerRange(e,t){return[(e=randFromRangeS(e))[0]-t,e[0]+t,e[2]]}function overwriteAxis(){let e=randFromRangeS(hashOverwrites.axisAngle)[0],t=randFromRangeS(hashOverwrites.axisAngle)[0],r=shuffleS([[e-2,e+2,1],[e-2,e+2,1],[e-2,e+2,1],[t-2,t+2,1],[t-2,t+2,1],[t-2,t+2,1],[t-2,t+2,1],]);for(let a=0;a<Axis.length;a++){let n=Axis[a],o=r.pop();n.name=`axis${a+1}`,n.axisAngle=o,n.originalAxisAngle=o,n.axisExtremeAngle=void 0,n.extremeAngleEnabledTimestamp=void 0,n.axisX=smallerRange(hashOverwrites.axisX,5),n.axisY=smallerRange(hashOverwrites.axisY,5),n.axisZ=smallerRange(hashOverwrites.axisZ,5)}}function populatePalette(){palettes=shuffleS(palettes),SCENE.palette=pickFromProbabilityMapS(palettes),worldGradientColors=[[SCENE.palette.gradient[2],SCENE.palette.gradient[0]],[SCENE.palette.gradient[3],SCENE.palette.gradient[1]]],enableFog=pickS([!0,!1]),fogColor=pickS(SCENE.palette.colors.filter(e=>e!=SCENE.palette.gradient[0]&&e!=SCENE.palette.gradient[1])),console.log(fogColor)}function populateAxisExtraShapes(){for(shapeType in extraShapes){(shapeParams=extraShapes[shapeType]).originalNumberOfShapes=shapeParams.numberOfShapes,shapeParams.numberOfShapes=randS(shapeParams.numberOfShapes[0],shapeParams.numberOfShapes[1]||shapeParams.numberOfShapes[0],1),shapeParams.material=pickFromProbabilityArrayS(shapeParams.material);for(let e=0;e<Axis.length;e++)shapeParams.axisToBeAddedTo=pick(shapeParams.axis);if(shapeParams.secondColor){let t=pickS(SCENE.palette.colors);Array.isArray(t)&&(t=t[0]),shapeParams.secondColor=t}}for(let r=0;r<Axis.length;r++)for(shapeType in Axis[r].extraShapes={},extraShapes)(shapeParams=JSON.parse(JSON.stringify(extraShapes[shapeType]))).axisToBeAddedTo==r+1&&randS(0,1,.01)>=1-shapeParams.probability&&(Axis[r].extraShapes[shapeType]=shapeParams)}function populateAbstractMaterials(){for(let e in materialTemplates){let t=materialTemplates[e];t={color:t[0],wireframe:t[2],shininess:t[1],enableTexture:t[3],textureColorVariant:pickS(t[4]),textureSize:t[13],textureNoiseSize:t[14],textureBase:t[11],textureMultiplier:t[12],textureBumpAmount:t[16],enableTextureBump:t[15],textureOffset:t[10],textureScale:t[8],textureRecolor:t[7],textureRotation:t[9],useTextureTransparency:t[6],textureBumpVariant:t[5]};let r=pickS2(SCENE.palette.colors),a=r[0],n=r[1];t.color=a,t.textureRecolor=n;let o=[void 0,void 0],i=t.color,l=!1;"boolean"==typeof t.wireframe?l=t.wireframe:(l=randS(0,1,.01)>1-t.wireframe,console.log(t.wireframe,l));let s=t.shininess,$;if("number"==typeof t.enableTexture&&(t.enableTexture=randS(0,1,.001)>1-t.enableTexture),t.enableTexture){if(["simple","perlin3","simplex3"].indexOf(t.textureColorVariant)>=0){let u=makePerlinTexture(t.textureSize[0],t.textureSize[1],t.textureNoiseSize[0],t.textureNoiseSize[1],t.textureBase,t.textureMultiplier,!0,t.textureBumpAmount,t.textureColorVariant);o[0]=u[0],t.enableTextureBump&&(o[1]=u[1])}else if(t.textureColorVariant in base64Textures){let c=loadTextureRecolor(t.textureColorVariant,t.textureOffset[0],t.textureOffset[1],t.textureScale[0],t.textureScale[1],t.textureRecolor,i,t.textureRotation);if(t.useTextureTransparency&&($=loadTextureRecolor(t.textureColorVariant,t.textureOffset[0],t.textureOffset[1],t.textureScale[0],t.textureScale[1],"#FFFFFF","#000000",t.textureRotation)),o[0]=c,t.enableTextureBump){if(t.textureColorVariant==t.textureBumpVariant)o[1]=c;else{let p=makePerlinTexture(t.textureSize[0],t.textureSize[1],t.textureNoiseSize[0],t.textureNoiseSize[1],t.textureBase,t.textureMultiplier,!0,t.textureBumpAmount,t.textureColorVariant);o[1]=p[0]}}}}let d={type:"phong",color:i,side:THREE.DoubleSide,wireframe:l,shininess:s,map:o[0],bumpMap:o[1],alphaMap:$},f=makeMaterial(d);f.userData.name=e,materialTemplates[e]=f}}function modifyMesh(e,t){let r=e.geometry.getAttribute("position").count;for(var a=0;a<r;a++){let n=e.geometry.getAttribute("position").getX(a),o=e.geometry.getAttribute("position").getY(a),i=e.geometry.getAttribute("position").getZ(a);(newXYZ=t(r,a,n,o,i,e))[0]!=n&&e.geometry.getAttribute("position").setX(a,newXYZ[0]),newXYZ[1]!=o&&e.geometry.getAttribute("position").setY(a,newXYZ[1]),newXYZ[2]!=i&&e.geometry.getAttribute("position").setZ(a,newXYZ[2])}return e}function vertexIndexSequence(e){e-=1;let t=[];for(let r=0;r<e;r++){let a=r,n=r+1,o=e-r;n==o&&n++,t=t.concat(a,n,o)}return t}function makeExtrudeShapeMesh(e,t,r,a){function n(e){let t=new THREE.Shape;for(let r=0;r<e.length;r++)0==r?t.moveTo(e[r][0],e[r][1]):t.lineTo(e[r][0],e[r][1]);return t}let o=n(e);if(t.length>0){let i=n(t);o.holes.push(i)}let l=new THREE.ExtrudeGeometry(o,r);return new THREE.Mesh(l,a)}function makeFrame(e,t,r,a,n,o,i,l){let s=[[t,r],[t,-r],[-t,-r],[-t,r]],$=[];for(let u of s){let c=u[0]<0?u[0]+a:u[0]-a,p=u[1]<0?u[1]+a:u[1]-a;$.push([c,p])}let d=makeExtrudeShapeMesh(s,$,{steps:2,depth:n,bevelEnabled:!1},e);return i&&d.position.set(i[0],i[1],i[2]),o&&d.scale.set(o[0],o[1],o[2]),l&&d.rotation.set(THREE.MathUtils.degToRad(l[0]),THREE.MathUtils.degToRad(l[1]),THREE.MathUtils.degToRad(l[2])),d}function makeRectangle(e,t,r,a,n,o,i){let l=makeExtrudeShapeMesh([[t,r],[t,-r],[-t,-r],[-t,r]],[],{steps:2,depth:a,bevelEnabled:!1},e);return o&&l.position.set(o[0],o[1],o[2]),n&&l.scale.set(n[0],n[1],n[2]),i&&l.rotation.set(THREE.MathUtils.degToRad(i[0]),THREE.MathUtils.degToRad(i[1]),THREE.MathUtils.degToRad(i[2])),l}function makeArrow(e,t,r,a,n,o,i,l,s=0){if(0==s)var $=[[4.23,.1],[.65,8.65],[-3.48,-.71],[-.4,.84],[-.97,-6.59],[.73,-6.52],[1.02,1.08],];else if(1==s)var $=[[-4.13,-1],[.65,8.65],[-3.48,-.71],[-.4,-.84],[-.07,-.09],[.73,-.52],[1.02,1.08],];else if(2==s)var $=[[-4.13,-1],[.65,1.55,8.65,3.56,.22],[-3.48,-.71],[-.4,-.84],[-.07,-.09],[.73,-.52],[1.02,1.08],];else if(3==s)var $=[[-14.13,9],[.65,-1.55,8.65,-3.56,.22],[-13.48,10.71],[-20.4,-.84],[-.07,-.09],[2.73,-.52],[1.02,1.08],];let u=makeExtrudeShapeMesh($,[],{steps:2,depth:t,bevelEnabled:!0,bevelThickness:r,bevelSize:a,bevelOffset:0,bevelSegments:n},e);return i&&u.position.set(i[0],i[1],i[2]),o&&u.scale.set(o[0],o[1],o[2]),l&&u.rotation.set(THREE.MathUtils.degToRad(l[0]),THREE.MathUtils.degToRad(l[1]),THREE.MathUtils.degToRad(l[2])),u}function makeKnot(e,t,r,a,n,o,i,l,s,$){let u=new THREE.TorusKnotGeometry(t,r,a,n,o,i);u.computeVertexNormals();let c=new THREE.Mesh(u,e);return s&&c.position.set(s[0],s[1],s[2]),l&&c.scale.set(l[0],l[1],l[2]),$&&c.rotation.set(THREE.MathUtils.degToRad($[0]),THREE.MathUtils.degToRad($[1]),THREE.MathUtils.degToRad($[2])),c}function makeMaterial(e={type:void 0,color:void 0,side:void 0,wireframe:void 0,shininess:void 0,map:void 0,bumpMap:void 0,alphaMap:void 0}){let t={color:e.color?e.color:"#FFFFFF",side:e.side,wireframe:e.wireframe,shininess:e.shininess};e.map&&(t.map=e.map,e.alphaMap&&(t.alphaMap=e.alphaMap,t.alphaTest=.8,t.premultipliedAlpha=!0)),e.bumpMap&&(t.bumpMap=e.bumpMap);let r=new THREE.MeshPhongMaterial(t);return r.userData.used=!1,r}function loadTexture(e,t,r,a,n,o){if(o){var i=document.createElement("canvas");i.width=512,i.height=512;var l=i.getContext("2d"),s=new THREE.Texture(i),$=new Image;$.src=`data:image/png;base64,${base64Textures[e]}`,$.onload=function(){l.fillStyle="rgba(255,255,255,1)",l.fillRect(0,0,i.width,i.height),l.globalCompositeOperation=o[3],l.filter=`hue-rotate(${o[0]}deg) grayscale(${o[1]}%) brightness(${o[2]}%)`,l.drawImage($,0,0,i.width,i.height),l.globalCompositeOperation="source-over",l.fillStyle="rgb(255,0,0)",l.fillRect(0,0,i.width,i.height),s.needsUpdate=!0,l.globalCompositeOperation="source-over"},s.wrapS=THREE.RepeatWrapping,s.wrapT=THREE.RepeatWrapping}else var s=new THREE.TextureLoader().load(`data:image/png;base64,${base64Textures[e]}`);return t&&r&&s.offset.set(a,n),a&&n&&s.repeat.set(a,n),s}function loadTextureRecolor(e,t,r,a,n,o,i,l){var s=document.createElement("canvas");s.width=128,s.height=128;var $=s.getContext("2d"),u=new THREE.Texture(s),c=new Image;return c.src=`data:image/png;base64,${base64Textures[e]}`,c.onload=function(){$.globalCompositeOperation="copy",$.drawImage(c,0,0,s.width,s.height),o&&($.globalCompositeOperation="source-in",$.fillStyle=o,$.fillRect(0,0,s.width,s.height)),$.globalCompositeOperation="destination-atop",$.fillStyle=i,$.fillRect(0,0,s.width,s.height),u.wrapS=THREE.RepeatWrapping,u.wrapT=THREE.RepeatWrapping,t&&r&&u.offset.set(t,r),a&&n&&u.repeat.set(a,n),l&&(u.rotation=THREE.MathUtils.degToRad(l)),u.needsUpdate=!0},u}function generateHeight(e,t){let r=Math.PI/4;window.Math.random=function(){let e=1e4*Math.sin(r++);return e-Math.floor(e)};let a=e*t,n=new Uint8Array(a),o=new THREE.ImprovedNoise,i=100*Math.random(),l=1;for(let s=0;s<4;s++){for(let $=0;$<a;$++){let u=$%e,c=~~($/e);n[$]+=Math.abs(o.noise(u/l,c/l,i)*l*1.75)}l*=5}return n}function generateTexture(e,t,r){let a,n,o,i,l=new THREE.Vector3(0,0,0),s=new THREE.Vector3(1,1,1);s.normalize();let $=document.createElement("canvas");$.width=t,$.height=r,(a=$.getContext("2d")).fillStyle="#000",a.fillRect(0,0,t,r),o=(n=a.getImageData(0,0,$.width,$.height)).data;for(let u=0,c=0,p=o.length;u<p;u+=4,c++)l.x=e[c-2]-e[c+2],l.y=2,l.z=e[c-2*t]-e[c+2*t],l.normalize(),i=l.dot(s),o[u]=(96+128*i)*(.5+.007*e[c]),o[u+1]=(32+96*i)*(.5+.007*e[c]),o[u+2]=96*i*(.5+.007*e[c]);a.putImageData(n,0,0);let d=document.createElement("canvas");d.width=4*t,d.height=4*r,(a=d.getContext("2d")).scale(4,4),a.drawImage($,0,0),o=(n=a.getImageData(0,0,d.width,d.height)).data;for(let f=0,_=o.length;f<_;f+=4){let g=~~(5*Math.random());o[f]+=g,o[f+1]+=g,o[f+2]+=g}return a.putImageData(n,0,0),d}function makeTerrain(e,t,r,a,n,o,i,l){let s=t,$=r,u=generateHeight(s,$),c=new THREE.PlaneGeometry(t,r,s-1,$-1);c.rotateX(-Math.PI/2);let p=c.attributes.position.array;for(let d=0,f=0,_=p.length;d<_;d++,f+=3)p[f+1]=u[d]*a;let g=new THREE.Mesh(c,e);if(l)for(let m of l)m.rotateX(-Math.PI/2),g.add(m);return o&&g.position.set(o[0]-s/10,o[1]-100*a,o[2]),n&&g.scale.set(n[0],n[1],n[2]),i&&g.rotation.set(THREE.MathUtils.degToRad(i[0]),THREE.MathUtils.degToRad(i[1]),THREE.MathUtils.degToRad(i[2])),g}function makeLightning(e,t,r,a,n,o,i,l){let s=new THREE.Path,$=0;for(let u=0;u<a;u++)s.lineTo(r*rand(.5,1.5,.1),$*rand(1,1.5,.1)),r*=-1,$+=t;let c=s.getPoints(),p=new THREE.BufferGeometry().setFromPoints(c),d=new THREE.Line(p,e);return i&&d.position.set(i[0],i[1],i[2]),o&&d.scale.set(o[0],o[1],o[2]),l&&d.rotation.set(THREE.MathUtils.degToRad(l[0]),THREE.MathUtils.degToRad(l[1]),THREE.MathUtils.degToRad(l[2])),d.userData.counter=0,d.userData.maxCounter=n,d}function animateLightning(e,t){let r=e.geometry.getAttribute("position");e.userData.counter>e.userData.maxCounter&&(t.mainPivot.remove(e),t.lightnings.splice(t.lightnings.indexOf(e),1)),e.userData.counter++;for(let a=0;a<r.count;a++){let n=r.getX(a),o=r.getY(a),i=r.getZ(a);if(rand(0,1,.1)>.8){n*=-1,r.setXYZ(a,n,o,i),e.rotation.y=rand(0,90,1),r.needsUpdate=!0;return}if(rand(0,1,.1)>.8){i*=-1,r.setXYZ(a,n,o,i),e.rotation.y=rand(1,90,1),r.needsUpdate=!0;return}}}function makeAnimationForQueue(e,t,r,a,n,o=.3){n=n<0?-1*n:n;let i={attribute:e,from:t,current:t,to:r,final:a,speed:n,counter:0,curve:o};return"color"==e&&(t="string"==typeof t?t:"#"+t.getHex().toString(16),r=Array.isArray(r)?r:[r],i.colorInterpolator=new ColorInterpolator([t].concat(r),n)),i}function processAnimationQueue(e){if(void 0==e.userData.animationQueue||0==e.userData.animationQueue.length)return;let t=e.userData.animationQueue[0];if(t.counter>1e4){e.userData.animationQueue.splice(0,1);return}if(t.counter++,"color"==t.attribute){if(e.color){let r=new THREE.Color(t.colorInterpolator.nextColor());e.color=r,t.colorInterpolator.looped&&e.userData.animationQueue.splice(0,1)}else console.error("Shape has no color attribute");return}if(Array.isArray(t.from))for(let a=0;a<t.from.length;a++){if(t.from[a]>=t.to[a]&&t.current[a]<=t.to[a]||t.from[a]<=t.to[a]&&t.current[a]>=t.to[a]){e.userData.animationQueue.splice(0,1);return}t.from[a]>t.to[a]?t.current[a]-=t.speed:t.current[a]+=t.speed}else{if("scale"==t.attribute?t.current=Math.max(e.scale.x,e.scale.y,e.scale.z):"rotationSpeed"==t.attribute?t.current=e.userData.rotationSpeed:"distance"==t.attribute?t.current=e.position.x:"x"==t.attribute?t.current=e.position.x:"y"==t.attribute?t.current=e.position.y:"z"==t.attribute?t.current=e.position.z:"near-far"==t.attribute?(t.current[0]=e.near,t.current[1]=e.far):"angleX"==t.attribute?t.current=e.rotation.x:"angleY"==t.attribute?t.current=e.rotation.y:"angleZ"==t.attribute&&(t.current=e.rotation.z),t.from>=t.to&&t.current<=t.to||t.from<=t.to&&t.current>=t.to){e.userData.animationQueue.splice(0,1);return}t.from>=t.to?t.current-=t.speed:t.current+=t.speed}if("scale"==t.attribute){if(e.scale.set(t.current,t.current,t.current),Array.isArray(e.material))for(let n=0;n<e.material.length;n++)e.material[n].map&&(e.material[n].map.needsUpdate=!0);else e.material&&e.material.map&&(e.material.map.needsUpdate=!0)}else"rotationSpeed"==t.attribute?e.userData.rotationSpeed=t.current:"distance"==t.attribute?e.position.x=t.current:"x"==t.attribute?e.position.x=t.current:"y"==t.attribute?e.position.y=t.current:"z"==t.attribute?e.position.z=t.current:"near-far"==t.attribute?(e.near=t.current[0],e.far=t.current[1]):"angleX"==t.attribute?e.rotation.x=t.current:"angleY"==t.attribute?e.rotation.y=t.current:"angleZ"==t.attribute&&(e.rotation.z=t.current)}function processAnimationLoop(e){if(0!=e.userData.animationLoop.length)for(let t of e.userData.animationLoop){if("color"==t.attribute){if(e.color){let r=new THREE.Color(t.colorInterpolator.nextColor());e.color=r,t.colorInterpolator.looped&&e.userData.animationQueue.splice(0,1)}else console.error("Shape has no color attribute");return}if("scale"==t.attribute?t.current=Math.max(e.scale.x,e.scale.y,e.scale.z):"rotationSpeed"==t.attribute?t.current=e.userData.rotationSpeed:"distance"==t.attribute?t.current=e.position.x:"x"==t.attribute?t.current=e.position.x:"y"==t.attribute?t.current=e.position.y:"z"==t.attribute?t.current=e.position.z:"near-far"==t.attribute?(t.current[0]=e.near,t.current[1]=e.far):"angleX"==t.attribute?t.current=e.rotation.x:"angleY"==t.attribute?t.current=e.rotation.y:"angleZ"==t.attribute&&(t.current=e.rotation.z),t.from>=t.to?t.current-=t.speed:t.current+=t.speed,"scale"==t.attribute){if(e.scale.set(t.current,t.current,t.current),Array.isArray(e.material))for(let a=0;a<e.material.length;a++)e.material[a].map&&(e.material[a].map.needsUpdate=!0);else e.material.map&&(e.material.map.needsUpdate=!0)}else"rotationSpeed"==t.attribute?e.userData.rotationSpeed=t.current:"distance"==t.attribute?e.position.x=t.current:"x"==t.attribute?e.position.x=t.current:"y"==t.attribute?e.position.y=t.current:"z"==t.attribute?e.position.z=t.current:"near-far"==t.attribute?(e.near=t.current[0],e.far=t.current[1]):"angleX"==t.attribute?e.rotation.x=t.current:"angleY"==t.attribute?e.rotation.y=t.current:"angleZ"==t.attribute&&(e.rotation.z=t.current)}}function interpolateColors(e,t,r){var a;let n=e=>[parseInt(e.slice(1,3),16),parseInt(e.slice(3,5),16),parseInt(e.slice(5,7),16)],o=n(e),i=n(t),l=o.map((e,t)=>{let a=i[t];return Math.round(e+(a-e)*r)});return"#"+l.map(e=>Math.round(e).toString(16).padStart(2,"0")).join("")}class ColorInterpolator{constructor(e,t){this.colorsArray=e,this.activePairIndex=[0,1],this.speed=t,this.state=0,this.looped=!1}nextColor(){let e=interpolateColors(this.colorsArray[this.activePairIndex[0]],this.colorsArray[this.activePairIndex[1]],this.state);return this.state+=this.speed,this.state>=1&&(this.state=0,this.activePairIndex[1]>=this.colorsArray.length?this.activePairIndex=this.activePairIndex.map(e=>e+1):(this.activePairIndex=[0,1],this.looped=!0)),e}}function createConeGeometry(e,t,r,a,n,o){n||(n={});let i=new THREE.BufferGeometry,l=[],s=[],$=e;for(let u=0;u<=a;u++){let c=u/a*t,p=$+c/t*(0-$);for(let d=0;d<=r;d++){let f=c,_=d/r*Math.PI*2,g=p*Math.cos(_),m=p*Math.sin(_);n.slantCone&&(g+=Math.sin(f/a)*$),n.sideBaseCutCone&&(f+=Math.sin(g/a)*n.sideBaseCutFactor),n.mountain&&(f+=Math.sin(g*a)*Math.cos(g*n.mountainFactor)),n.extremeSlantCone&&(g+=(t-f)*n.slantConeExtremeFactor),n.hookCone&&(g+=Math.abs(t/n.hookPosFactor-f)*n.hookFactor),n.bulgyCone&&(g*=1+f*n.bulgyFactorX,m*=1+f*n.bulgyFactorZ,f*=f==t?n.bulgyFactorY:1),n.curveBaseCone&&(f-=Math.abs(Math.pow(g,2))*((a-u)*n.baseCurveFactor)),n.specialCone1&&(g=p*Math.cos(_*Math.sin(c)),m=p*Math.sin(_*Math.sin(p))),n.specialCone2&&(g=p*Math.cos(_*Math.sin(p)),m=p*Math.sin(_*Math.sin(c))),l.push(g,f,m)}}for(let h=0;h<a;h++)for(let x=0;x<r;x++){let b=h*(r+1)+x,w=b+r+1;if(0==x)var S=b,y=w;x<r-1?(s.push(b,w,b+1),s.push(w,w+1,b+1)):(s.push(b,w,S),s.push(w,y,S))}let v=0,T=100,P=0;for(let R=2;R<3*r;R+=3)P++,l[R]<v&&(v=P,T=l[R]);if(l.indexOf(Math.min(l.slice(0,r))),!o){l=l.slice(0,3*r).concat(l),s=s.map(e=>e+r);let C=Math.abs(r/2);if(n.curveBaseCone)s=s.concat(vertexIndexSequence(r));else for(let M=0;M<C;M+=1)s.push(M,M+1,C),s.push(M+C,M+C+1,C)}return i.setAttribute("position",new THREE.Float32BufferAttribute(l,3)),i.deleteAttribute("normal"),i.deleteAttribute("uv"),i.setIndex(s),i.computeVertexNormals(),i}function makeCone(e,t,r,a,n,o,i,l,s,$){let u=createConeGeometry(t,r,a,n,$,o),c=new THREE.ConeGeometry(t,r,a,n);u.setAttribute("uv",c.getAttribute("uv")),u.uvsNeedUpdate=!0,u.normalsNeedUpdate=!0;let p=new THREE.Mesh(u,e);return l&&p.position.set(l[0],l[1],l[2]),i&&p.scale.set(i[0],i[1],i[2]),s&&p.rotation.set(THREE.MathUtils.degToRad(2*s[0]),THREE.MathUtils.degToRad(s[1]),THREE.MathUtils.degToRad(s[2])),enableShadows&&(p.castShadow=!0,p.receiveShadow=!0),p.userData.material=e,p}function meanPositionOfPivots(e){let t=e.map(e=>e.position.x);t=t.reduce((e,t)=>e+t,0)/t.length;let r=e.map(e=>e.position.y);r=r.reduce((e,t)=>e+t,0)/r.length;let a=e.map(e=>e.position.z);return[t,r,a=a.reduce((e,t)=>e+t,0)/a.length]}function meanRotationOfPivots(e){let t=e.map(e=>e.rotation.x);t=t.reduce((e,t)=>e+t,0)/t.length;let r=e.map(e=>e.rotation.y);r=r.reduce((e,t)=>e+t,0)/r.length;let a=e.map(e=>e.rotation.z);return[t,r,a=a.reduce((e,t)=>e+t,0)/a.length]}function createNegativeSpace(e,t=!0){let r=randFromRange(e.negativeSpaceX),a=randFromRange(e.negativeSpaceY),n=randFromRange(e.negativeSpaceZ),o=randFromRange(e.negativeSpaceSizeX),i=randFromRange(e.negativeSpaceSizeY),l=randFromRange(e.negativeSpaceSizeZ),s=pick(e.negativeSpaceType),$;"triangle"==s?(($=[new THREE.Plane(new THREE.Vector3(1,.5,0),0),new THREE.Plane(new THREE.Vector3(-1,.5,0),0),new THREE.Plane(new THREE.Vector3(0,-1,0),0),new THREE.Plane(new THREE.Vector3(0,0,-1),0),new THREE.Plane(new THREE.Vector3(0,0,1),0),])[0].translate(new THREE.Vector3(o+r,0,0)),$[1].translate(new THREE.Vector3(-o+r,0,0)),$[2].translate(new THREE.Vector3(0,-i+a,0)),$[3].translate(new THREE.Vector3(0,0,-l+n)),$[4].translate(new THREE.Vector3(0,0,l+n))):"diamond"==s?(($=[new THREE.Plane(new THREE.Vector3(1,-.5,0),0),new THREE.Plane(new THREE.Vector3(-1,.5,0),0),new THREE.Plane(new THREE.Vector3(.5,-1,0),0),new THREE.Plane(new THREE.Vector3(-.5,1,0),0),new THREE.Plane(new THREE.Vector3(0,0,-1),0),new THREE.Plane(new THREE.Vector3(0,0,1),0),])[0].translate(new THREE.Vector3(o+r,0,0)),$[1].translate(new THREE.Vector3(-o+r,0,0)),$[2].translate(new THREE.Vector3(0,-i+a,0)),$[3].translate(new THREE.Vector3(0,i+a,0)),$[4].translate(new THREE.Vector3(0,0,-l+n)),$[5].translate(new THREE.Vector3(0,0,l+n))):"rectangle"==s&&(($=[new THREE.Plane(new THREE.Vector3(1,0,0),0),new THREE.Plane(new THREE.Vector3(-1,0,0),0),new THREE.Plane(new THREE.Vector3(0,-1,0),0),new THREE.Plane(new THREE.Vector3(0,1,0),0),new THREE.Plane(new THREE.Vector3(0,0,-1),0),new THREE.Plane(new THREE.Vector3(0,0,1),0),])[0].translate(new THREE.Vector3(o+r,0,0)),$[1].translate(new THREE.Vector3(-o+r,0,0)),$[2].translate(new THREE.Vector3(0,-i+a,0)),$[3].translate(new THREE.Vector3(0,i+a,0)),$[4].translate(new THREE.Vector3(0,0,-l+n)),$[5].translate(new THREE.Vector3(0,0,l+n))),SCENE.scene.add(new THREE.PlaneHelper($[0],20,16777215)),SCENE.scene.add(new THREE.PlaneHelper($[1],20,16777215)),SCENE.scene.add(new THREE.PlaneHelper($[2],20,16777215)),SCENE.scene.add(new THREE.PlaneHelper($[3],20,16777215)),SCENE.scene.add(new THREE.PlaneHelper($[4],20,16777215));let u="triangle"==s?3:4;for(let c=0;c<u;c++)$[c].userData={originalConstant:$[c].constant,currentConstrain:t?5:$[c].constant,desiredConstant:$[c].constant},t&&($[c].constant=5);if(e.clipPlanes=$,e.pivots)for(let p of e.pivots)for(let d of p.children)for(let f of(d.material&&(d.material.clippingPlanes=e.clipPlanes,d.material.clipIntersection=!0),d.children))f.material&&(f.material.clippingPlanes=e.clipPlanes,f.material.clipIntersection=!0)}function removeNegativeSpace(e){for(let t=0;t<e.clipPlanes.length;t++)e.clipPlanes[t].userData&&(e.clipPlanes[t].userData.desiredConstant=5);setTimeout(5e3,()=>{if(e.pivots)for(let t of e.pivots)for(let r of t.children)for(let a of(r.material&&(r.material.clippingPlanes=void 0,r.material.needsUpdate=!0),r.children))a.material&&(a.material.clippingPlanes=void 0,a.material.needsUpdate=!0);delete e.clipPlanes})}function average_delta_array(e){let t=0;for(let r=1;r<e.length;r++)t+=Math.abs(e[r]-e[r-1]);return t/(e.length-1)}function map_scale(e,t,r){if(r<=e[0])return t[0];if(r>=e[e.length-1])return t[t.length-1];for(let a=0;a<t.length-1;a++)if(r>=e[a]&r<e[a+1])return t[a]}function delta_gap(e,t){let r=average_delta_array(t),a=(e-t[t.length-1])/r-1;return null==a||isNaN(a)?0:a}let adjust_tier=(e,t)=>{if(0==t)return t;let r=t<0?-1:1;return t=Math.abs(t),e>=0&&(t-=1),e>=1&&(t-=2),e>=2&&(t-=3),-0==(t=Math.max(0,t)*r)?0:t};function calculateTiers(e){if(!e){console.warn("No data");return}let t={royalty:[[-.4,-.3,-.1,0,.1,.3,.6],[-3,-2,-1,0,1,2,3]],contract_activity:[[-1,-.5,-.25,0,.25,.5,.75],[-3,-2,-1,0,1,2,3]],clustering_mode:[[-1,-.5,-.25,0,.25,.5,.75],[-3,-2,-1,0,1,2,3]],approvals:[[-1,-.5,-.25,0,.25,.5,.75],[-3,-2,-1,0,1,2,3]]},r=new Date().getTime()/1e3;e[0];let a=e[1],n=e[2],o=e[3],i=e[4];e[5];let l=e[6];a=[...new Set(a)],n=[...new Set(n)],o=[...new Set(o)],l=[...new Set(l)],a.sort(),n.sort(),o.sort(),l.sort();let s=Array.from(n),$=Array.from(o),u=Array.from(a),c=Array.from(i);a.length<=1&&(u=[1715731200].concat(a)),l.length<=1&&(l=[1715731200].concat(l)),n.length<=1&&(s=[1715731200].concat(n)),o.length<=1&&($=[1715731200].concat(o)),i.length<=1&&(c=[25e15].concat(i));let p=delta_gap(r,a.length>1?a:u),d=delta_gap(r,n.length>1?n:s),f=delta_gap(r,o.length>1?o:$),_=0;c.length>1&&(_=c[c.length-1]/(c.slice(0,-1).reduce((e,t)=>e+t)/(c.length-1))-1);let g=delta_gap(r,a.concat(s).sort().slice(-5)),m=adjust_tier(f,map_scale(t.royalty[0],t.royalty[1],_)),h=adjust_tier(p,map_scale(t.contract_activity[0],t.contract_activity[1],-1*g)),x=adjust_tier(p,map_scale(t.clustering_mode[0],t.clustering_mode[1],-1*p)),b=adjust_tier(d,map_scale(t.approvals[0],t.approvals[1],-1*d));SCENE.data.contract.tiers={royalty_received_tier:m,contract_activity_tier:h,sends_tier:x,approvals_tier:b},console.log("Tiers:",SCENE.data.contract.tiers)}function tierToValue(e,t){return e[[-3,-2,-1,0,1,2,3].indexOf(t)]}function getCurrentTs(){return new Date().getTime()/1e3}